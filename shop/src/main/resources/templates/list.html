<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="/main.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body style="background:rgb(235,235,235);">
    <div th:replace="~{ nav.html::navbar }"></div>
    <div th:replace="~{ nav.html::welcome }"></div>
    <div style="text-align:center;">
        <form action="/search" method="POST">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input name="searchText" style="display:inline;">
            <button type="submit">Í≤ÄÏÉâ</button>
        </form>



        <div class="card" th:each="item: ${items}">
            <img src="https://placehold.co/300">

            <div>
                <a th:href="@{ '/detail/' + ${item.id}} + '?pageNum=1'">
                    <h4 th:text="${item.title}">Î∞îÏßÄ</h4>
                </a>
                <p th:text="${item.price}">7Ïñµ</p>

                <div class="option">
                    <a th:href="@{ '/detail/' + ${item.id}+ '/update'} " style="margin-left:5px;">
                        ÏàòÏ†ï‚úèÔ∏è
                    </a>
                    <span class="delete_btn" th:data-id="${item.id}" style="cursor:pointer;">
                    ÏÇ≠Ï†úüóëÔ∏è
                </span>

                </div>
            </div>

        </div>
    </div>
    <div th:if="cnt!=null" class="container" >
        <span th:if="${cnt > 0}" th:each="i: ${#numbers.sequence(1, cnt)}" >
            <a th:if="${i == cnt_now}" th:text="${i}" class="page-btn blue" th:href="@{/list/page/{i}(i=${i})}"></a>
            <a th:if="${i!=cnt_now}" th:text="${i}" class="page-btn white" th:href="@{/list/page/{i}(i=${i})}"></a>
        </span>
    </div>

    <!-- Navigation Bar -->
    <div th:replace="~{ footer.html::footer }"></div>
    <script>
        document.querySelectorAll('.delete_btn').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = button.getAttribute('data-id');

                // CSRF ÌÜ†ÌÅ∞ Î∞è Ìó§Îçî Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch('/delete?id=' + encodeURIComponent(itemId), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken  // CSRF ÌÜ†ÌÅ∞ÏùÑ Ìó§ÎçîÏóê Ï∂îÍ∞Ä
                    }
                })
                .then(response => response.text())
                .then(() => {
                    location.reload();
                })
                .catch(error => console.error('Error:', error));
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
        const logoutElement = document.getElementById('logout');

        if (logoutElement) {
            logoutElement.onclick = function() {
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch('/logout_jwt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken // CSRF ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
                    },
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = '/login'; // Î¶¨Îã§Ïù¥Î†âÌä∏
                    } else {
                        console.error('Logout failed:', response.statusText);
                    }
                });
            };
        }
    });
    </script>

</body>
</html>